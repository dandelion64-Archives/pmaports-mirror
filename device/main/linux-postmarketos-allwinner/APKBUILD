# Maintainer: Jan Jasper de Kroon <jajadekroon@gmail.com>
# Co-Maintainer: Arnav Singh <me@arnavion.dev>
_flavor=postmarketos-allwinner
pkgname=linux-$_flavor
pkgver=6.7.2_git20240127
pkgrel=1
_tag="orange-pi-6.7-20240127-1717"
pkgdesc="Kernel fork with Pine64 patches (megi's tree, slightly patched)"
arch="aarch64 armv7"
url="https://megous.com/git/linux/"
license="GPL-2.0-only"
makedepends="
	bison
	devicepkg-dev
	findutils
	flex
	gmp-dev
	lz4
	mpc1-dev
	mpfr-dev
	openssl-dev
	perl
	postmarketos-installkernel
	rsync
	xz
	bash
	"
options="!strip !check !tracedeps
	pmb:cross-native
	pmb:kconfigcheck-community
	"
source="$pkgname-$_tag.tar.gz::https://codeberg.org/megi/linux/archive/$_tag.tar.gz
	arm64_defconfig
	kconfig-0001-keyboard-as-module.config
	kconfig-0002-mglru.config
	kconfig-0003-default-cpufreq-governor.config
	kconfig-0004-rcu-lazy.config
	kconfig-0005-fscache.config
	kconfig-0006-rtw88.config
	kconfig-0007-no-modem-power.config
	0001-dts-add-dontbeevil-pinephone-devkit.patch
	0002-dts-add-pinetab-dev-old-display-panel.patch
	0003-dts-pinetab-add-missing-bma223-ohci1.patch
	0004-arm64-dts-allwinner-Add-bluetooth-node-to-the-PineTa.patch
	0005-dts-pinetab-make-audio-routing-consistent-with-pinep.patch
	0006-dts-pinephone-drop-modem-power-node.patch
	0007-drm-panel-simple-Add-Hannstar-TQTM070CB501.patch
	0008-ARM-dts-sun6i-Add-GoClever-Orion-70L-tablet.patch
	0009-drm-panel-simple-Add-Hannstar-HSD070IDW1-A.patch
	0010-ARM-dts-sun6i-Add-Lark-FreeMe-70.2S-tablet.patch
	0011-sunxi-mmc-h6-fix.patch
	0012-arm64-dts-allwinner-orangepi-3-fix-ethernet.patch
	0013-Revert-usb-quirks-Add-USB_QUIRK_RESET-for-Quectel-EG25G-Modem.patch
	0014-usb-serial-option-add-reset-resume-callback-for-WWAN.patch
	"
builddir="$srcdir/linux"

case "$CARCH" in
	aarch64*)
		_carch="arm64"
		_pmos_defconfig="postmarketos_allwinner_defconfig"
		;;
	arm*)
		_carch="arm"
		_pmos_defconfig="orangepi_defconfig"
		;;
esac

prepare() {
	default_prepare

	if [ -f "$srcdir/${_carch}_defconfig" ]; then
		cp "$srcdir/${_carch}_defconfig" "$builddir/arch/$_carch/configs/postmarketos_allwinner_defconfig"
	fi

	. kernel_prepare
}

build() {
	. kernel_build
}

package() {
	. kernel_package
}

sha512sums="
0135ca518e82c7f858a7892b87c79e875d5f3f8d3ea884a969e6f3bb7f2a1fe260058debecce286e00a96b03c297533e4edf1859095837bd664793a29aaca41b  linux-postmarketos-allwinner-orange-pi-6.7-20240127-1717.tar.gz
cfa9caadee0f75e2f7a436a461152b1f16495bc9700fcebda335cf5c5f282c73f0c77397675e9c3fad69c2802e08f7fc8e5d0dc348f205bcf156769de3c598ec  arm64_defconfig
3ad2d233dae3034a7bb97ba1f2ba864a5cf46d7abe6eddbcf2afaa0002634c7f44da23a0733713ed223a2608d6528aecd72dc74f74a0cbeab31df33ac3b8d2a1  kconfig-0001-keyboard-as-module.config
fc398ba99bee7d20d38d7afdc38d5c90c095387ea46bc7a797f231ff0c84002b9e064cff6c74c5b0435b985c1b66e9344922807e311f973f93954e63f94732cf  kconfig-0002-mglru.config
7a73d7509e62e009f1d29efbaf85268691d13c3216eeccae5c434375c82ef52ee7807cbf72eb9ee9d49dca55d922ba84809a596e2a07f907a3b1a63e7c68c3dc  kconfig-0003-default-cpufreq-governor.config
06437784cfa191108a3f48600fc1f6d729d2fd986fa9dfb7b2708e61c4e7609ba67c44ccd0cb155466c895fe6276743d41e1d73c5c491d0d41465563d361d0a0  kconfig-0004-rcu-lazy.config
04b308d4e5ba9d19f4c24fd6978aae7a02d260dbbc0324fedd72683ffeb53177f7e59299a4bd9db8ac63ebf76431ca77cb4e51f97c1a2d0d8194bb9af6580409  kconfig-0005-fscache.config
ad1c9e236aa8cbbf9b06d9ebf6d71b94cbadde00cfe6e4daf391554d7a3d461ff821a5027f680023a3951f26bee0969cc47a10107dc6de25d065510086121ad7  kconfig-0006-rtw88.config
b44cd1ac130e6057cfc0bf6b13b9456f959105bb567d7a9557ae795c17ea18b942e47487405bb4c85fe9d84ff0d26dfd0009cf32608d618784d33186dab05952  kconfig-0007-no-modem-power.config
126e0a65e04f22f14eac1281a69000d9d5b107ed8fd1b52f37e812751f55e6c45b0240ceac61c9d95ae7f0543aaf9d96b85a8532baf59283c077b9945e615367  0001-dts-add-dontbeevil-pinephone-devkit.patch
99edeccdee7beae5dc7337d78ba92de2f3d724b7648ede30ab040a66bdac0e38a6595e212e26011d608ccb8a92ffa9e393965f936dfead65ffe9b7eb31dfa345  0002-dts-add-pinetab-dev-old-display-panel.patch
82c0203b02c671934d62e52311827ac1cc5b358e0843715ea2235117e4b47d6de63b29fdfc7c1adfc550cc7eb363c384de8276be1ca17da6e48916020124022d  0003-dts-pinetab-add-missing-bma223-ohci1.patch
1fcfcc448424af475efd7f848eec04763c5930070f54fdb487e6f28717df7e20b73c0f444e9322d362deeedfd87b4e91c6e61e274d23206fafef36ca97ff95d6  0004-arm64-dts-allwinner-Add-bluetooth-node-to-the-PineTa.patch
16373f069c8a3b110f68cce6d60a7b75af32635467454f4203ceeae2f7f3a74dce73f9c41b00bc340fae580cff335f0fa8d4b033cb31907b69e7a05030461b0f  0005-dts-pinetab-make-audio-routing-consistent-with-pinep.patch
681c945abdb8dd595d505a36ef84100b968754a1c861e7525c00185f19aa431304ff3c3258750d2d67a8aa2fd8e078a9bbc4b5cabb1802c24637ce26ecd3ee2d  0006-dts-pinephone-drop-modem-power-node.patch
c4ab9d65b4cd6ebe443cef51693ddaddfd55d3f73b5955b2c0211ecbc69054b17e875905f56c503873bb61f6fdb39e097d85d264d6e1bd6b7ab6526076ccd535  0007-drm-panel-simple-Add-Hannstar-TQTM070CB501.patch
943f8a9791461621c20b1dd0db9946a31734c4fe316626d045de2e2207e6f099d469e1a5b9ab9bd93cd5fca85b6422a211d435c6124aea1a2ecee818c7b35ac2  0008-ARM-dts-sun6i-Add-GoClever-Orion-70L-tablet.patch
952e2332cbc85e69259b037302411520d46c18bb90371492b6cfcc9eeeaf96d030875bf0a17edea756c9744faee38fd42288345681e5e903f6e64d0849f76db2  0009-drm-panel-simple-Add-Hannstar-HSD070IDW1-A.patch
b7c084bb32cfc18defcec77966f1944fd3b33bb48769a4c0e257709d0f3898c5e0ca2a50c39a5d4513463580eef58b5301e75345bd36d6cc5f84347f7d241a8c  0010-ARM-dts-sun6i-Add-Lark-FreeMe-70.2S-tablet.patch
8ee720bc6195b1b454a274e7ad9a245107aa6d127018b98909c5f105d608568bcf1651343bf9633f4804d5649f4df7e3390d6eb72a708666e89337e39427943a  0011-sunxi-mmc-h6-fix.patch
370e963805a4c984dc501a6a6f686cac059485a275370c5f55de0841e227c5f6652abb38ad935c8dd046014e632e70129d3f8fbeae9650fe7de6f0d10e9cdc3a  0012-arm64-dts-allwinner-orangepi-3-fix-ethernet.patch
c766911f76d36b997582533707d7d7a089ed1272e49a79dbe75f7c1eafef0ba3f1417d6c66f25e12e56124e0cd4bb9f443d400236e252ef1c43d53def9392a87  0013-Revert-usb-quirks-Add-USB_QUIRK_RESET-for-Quectel-EG25G-Modem.patch
382e6e8785235788101459ae47c940ec85831007c61e3f14c4e3a43abfa21b95cdaa6bdd1b7fdd6fd26944f4c629d41b9ab776e89d9a18778fbc9f6a7785444b  0014-usb-serial-option-add-reset-resume-callback-for-WWAN.patch
"
